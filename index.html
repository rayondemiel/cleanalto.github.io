<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ZIP File ALTO Cleaner</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50 min-h-screen">
    <div class="container mx-auto px-4 py-8 max-w-3xl">
        <header class="text-center mb-8">
            <h1 class="text-3xl font-bold text-gray-800 mb-2">ZIP File ALTO Cleaner</h1>
            <p class="text-gray-600">Upload a ZIP file containing XML files and select processing modes to clean up.</p>
        </header>
        
        <div class="bg-white rounded-lg shadow-md overflow-hidden mb-8">
            <div id="dropZone" class="border-2 border-dashed border-gray-300 rounded-lg p-8 transition-colors duration-200 cursor-pointer">
                <div id="dropZoneDefault" class="flex flex-col items-center justify-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 text-blue-500 mb-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
                    </svg>
                    <p class="text-gray-600 text-center">
                        Drag and drop a ZIP file here<br>or click to select
                    </p>
                    <input type="file" id="fileInput" accept=".zip" class="hidden">
                </div>
                <div id="dropZoneFile" class="hidden">
                    <div class="flex items-center justify-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-blue-500 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                        </svg>
                        <p id="selectedFileName" class="font-medium text-gray-800 break-all"></p>
                        <button id="removeFileButton" class="ml-3 bg-red-500 text-white rounded-full w-6 h-6 flex items-center justify-center hover:bg-red-600 transition-colors duration-200">
                            Ã—
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div class="bg-white rounded-lg shadow-md p-6 mb-8">
            <h3 class="text-xl font-semibold text-gray-800 mb-4">Select Processing Modes:</h3>
            
            <div class="border-l-4 border-green-500 pl-4 mb-6">
                <h4 class="font-medium text-gray-700 mb-2">Structure Operations:</h4>
                <div class="ml-2 mb-2">
                    <input type="checkbox" id="flattenStructure" name="processingMode" value="flattenStructure" class="w-4 h-4 text-blue-600 rounded focus:ring-blue-500">
                    <label for="flattenStructure" class="ml-2 text-gray-700 cursor-pointer">Move all XML files to root level</label>
                </div>
                <div class="ml-2 mb-2">
                    <input type="checkbox" id="compressXML" name="processingMode" value="compressXML" class="w-4 h-4 text-blue-600 rounded focus:ring-blue-500">
                    <label for="compressXML" class="ml-2 text-gray-700 cursor-pointer">Compress XML (remove whitespace and format)</label>
                </div>
            </div>

            <div class="border-l-4 border-blue-500 pl-4 mb-4">
                <h4 class="font-medium text-gray-700 mb-2">Content Operations:</h4>
                <div class="ml-2 mb-2">
                    <input type="checkbox" id="cleanFilenames" name="processingMode" value="cleanFilenames" class="w-4 h-4 text-blue-600 rounded focus:ring-blue-500">
                    <label for="cleanFilenames" class="ml-2 text-gray-700 cursor-pointer">Clean filenames (remove directory paths)</label>
                </div>
                <div class="ml-2 mb-2">
                    <input type="checkbox" id="removeGlyphs" name="processingMode" value="removeGlyphs" class="w-4 h-4 text-blue-600 rounded focus:ring-blue-500">
                    <label for="removeGlyphs" class="ml-2 text-gray-700 cursor-pointer">Remove &lt;Glyph&gt; elements and children</label>
                </div>
                <div class="ml-2 mb-2">
                    <input type="checkbox" id="removeStyles" name="processingMode" value="removeStyles" class="w-4 h-4 text-blue-600 rounded focus:ring-blue-500">
                    <label for="removeStyles" class="ml-2 text-gray-700 cursor-pointer">Remove style-related attributes</label>
                </div>
                <div class="ml-2 mb-2">
                    <input type="checkbox" id="cleanWhitespace" name="processingMode" value="cleanWhitespace" class="w-4 h-4 text-blue-600 rounded focus:ring-blue-500">
                    <label for="cleanWhitespace" class="ml-2 text-gray-700 cursor-pointer">Clean whitespace in text content</label>
                </div>
            </div>
            
            <div id="modeError" class="text-red-500 mt-3 hidden">Please select at least one processing mode.</div>
        </div>

        <div id="progress" class="hidden bg-white rounded-lg shadow-md p-6 mb-8">
            <h3 class="text-xl font-semibold text-gray-800 mb-4">Processing Files...</h3>
            <div class="w-full bg-gray-200 rounded-full h-5 mb-2 overflow-hidden">
                <div class="progress-fill h-full bg-green-500 transition-all duration-300 ease-out w-0"></div>
            </div>
            <p id="status" class="text-center text-gray-600">0%</p>
        </div>

        <div class="flex justify-center gap-4 mb-8">
            <button id="processButton" disabled class="px-6 py-3 bg-blue-500 text-white font-medium rounded-lg shadow transition-colors duration-200 hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-400 focus:ring-opacity-50 disabled:opacity-50 disabled:cursor-not-allowed">
                <span class="flex items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M11.49 3.17c-.38-1.56-2.6-1.56-2.98 0a1.532 1.532 0 01-2.286.948c-1.372-.836-2.942.734-2.106 2.106.54.886.061 2.042-.947 2.287-1.561.379-1.561 2.6 0 2.978a1.532 1.532 0 01.947 2.287c-.836 1.372.734 2.942 2.106 2.106a1.532 1.532 0 012.287.947c.379 1.561 2.6 1.561 2.978 0a1.533 1.533 0 012.287-.947c1.372.836 2.942-.734 2.106-2.106a1.533 1.533 0 01.947-2.287c1.561-.379 1.561-2.6 0-2.978a1.532 1.532 0 01-.947-2.287c.836-1.372-.734-2.942-2.106-2.106a1.532 1.532 0 01-2.287-.947zM10 13a3 3 0 100-6 3 3 0 000 6z" clip-rule="evenodd" />
                    </svg>
                    Process ZIP File
                </span>
            </button>
            <button id="downloadButton" disabled class="px-6 py-3 bg-green-500 text-white font-medium rounded-lg shadow transition-colors duration-200 hover:bg-green-600 focus:outline-none focus:ring-2 focus:ring-green-400 focus:ring-opacity-50 disabled:opacity-50 disabled:cursor-not-allowed">
                <span class="flex items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd" />
                    </svg>
                    Download Processed ZIP
                </span>
            </button>
        </div>

        <div id="fileStats" class="hidden bg-white rounded-lg shadow-md p-6 mb-8">
            <h4 class="text-lg font-semibold text-gray-800 mb-4">Processing Statistics:</h4>
            <div class="overflow-x-auto">
                <table class="min-w-full bg-white border-collapse">
                    <thead class="bg-gray-50 border-b">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">File</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Original Size</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Processed Size</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Reduction</th>
                        </tr>
                    </thead>
                    <tbody id="statsTable">
                        <!-- Data will be populated here -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        const dropZone = document.getElementById('dropZone');
        const fileInput = document.getElementById('fileInput');
        const processButton = document.getElementById('processButton');
        const downloadButton = document.getElementById('downloadButton');
        const progressBar = document.querySelector('.progress-fill');
        const progressStatus = document.getElementById('status');
        const progressDiv = document.getElementById('progress');
        const modeError = document.getElementById('modeError');
        
        let selectedFile = null;
        let processedZip = null;

        // Handle checkbox changes
        document.querySelectorAll('input[name="processingMode"]').forEach(checkbox => {
            checkbox.addEventListener('change', validateForm);
        });
        
        // Handle remove file button
        document.getElementById('removeFileButton').addEventListener('click', (e) => {
            e.stopPropagation(); // Prevent triggering the dropZone click
            selectedFile = null;
            fileInput.value = '';
            
            // Reset the UI
            document.getElementById('dropZoneDefault').classList.remove('hidden');
            document.getElementById('dropZoneDefault').classList.add('flex');
            document.getElementById('dropZoneFile').classList.add('hidden');
            document.getElementById('selectedFileName').textContent = '';
            document.getElementById('fileStats').classList.add('hidden');
            document.getElementById('progress').classList.add('hidden');
            
            // Disable buttons
            validateForm();
            downloadButton.disabled = true;
        });

        function validateForm() {
            const atLeastOneChecked = Array.from(document.querySelectorAll('input[name="processingMode"]'))
                .some(checkbox => checkbox.checked);
            
            processButton.disabled = !selectedFile || !atLeastOneChecked;
            modeError.classList.toggle('hidden', atLeastOneChecked);
        }

        // Drag and drop handlers
        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.classList.add('bg-blue-50', 'border-blue-300');
        });

        dropZone.addEventListener('dragleave', () => {
            dropZone.classList.remove('bg-blue-50', 'border-blue-300');
        });

        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('bg-blue-50', 'border-blue-300');
            const file = e.dataTransfer.files[0];
            if (file && file.type === 'application/zip') {
                handleFileSelection(file);
            }
        });

        dropZone.addEventListener('click', () => {
            fileInput.click();
        });

        fileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                handleFileSelection(file);
            }
        });

        function handleFileSelection(file) {
            selectedFile = file;
            
            // Show file name in the drop zone
            const dropZoneDefault = document.getElementById('dropZoneDefault');
            const dropZoneFile = document.getElementById('dropZoneFile');
            const selectedFileName = document.getElementById('selectedFileName');
            
            if (file) {
                selectedFileName.textContent = file.name;
                dropZoneDefault.classList.remove('flex');
                dropZoneDefault.classList.add('hidden');
                dropZoneFile.classList.remove('hidden');
            }
            
            validateForm();
            downloadButton.disabled = true;
            
            // Reset the file stats display when a new file is selected
            document.getElementById('fileStats').classList.add('hidden');
            document.getElementById('progress').classList.add('hidden');
        }

        function formatBytes(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function compressXML(xmlString) {
            // Remove comments
            xmlString = xmlString.replace(/<!--[\s\S]*?-->/g, '');
            
            // Remove white space between tags while preserving space in content
            xmlString = xmlString.replace(/>\s+</g, '><');
            
            // Remove leading and trailing whitespace from lines
            xmlString = xmlString.replace(/^\s+|\s+$/gm, '');
            
            // Remove empty lines
            xmlString = xmlString.replace(/(\r\n|\n|\r)/gm, '');
            
            return xmlString;
        }
        
        function processXMLContent(content, modes) {
            let processedContent = content;
            const parser = new DOMParser();
            const xmlDoc = parser.parseFromString(processedContent, 'text/xml');

            if (modes.includes('cleanFilenames')) {
                const fileNameElements = xmlDoc.getElementsByTagName('fileName');
                for (const elem of fileNameElements) {
                    const path = elem.textContent;
                    elem.textContent = path.split('/').pop();
                }
            }

            if (modes.includes('removeGlyphs')) {
                const glyphs = xmlDoc.getElementsByTagName('Glyph');
                while (glyphs.length > 0) {
                    glyphs[0].parentNode.removeChild(glyphs[0]);
                }
            }

            if (modes.includes('removeStyles')) {
                const elements = xmlDoc.getElementsByTagName('*');
                const styleAttributes = ['STYLE', 'COLOR', 'FONTSIZE', 'FONTSTYLE'];
                for (const elem of elements) {
                    styleAttributes.forEach(attr => {
                        elem.removeAttribute(attr);
                    });
                }
            }

            if (modes.includes('cleanWhitespace')) {
                const textNodes = xmlDoc.getElementsByTagName('String');
                for (const node of textNodes) {
                    if (node.hasAttribute('CONTENT')) {
                        const content = node.getAttribute('CONTENT');
                        node.setAttribute('CONTENT', content.trim().replace(/\s+/g, ' '));
                    }
                }
            }

            const serializer = new XMLSerializer();
            processedContent = serializer.serializeToString(xmlDoc);

            if (modes.includes('compressXML')) {
                processedContent = compressXML(processedContent);
            }

            return processedContent;
        }

        function getUniqueFilename(existingFiles, originalName) {
            const baseName = originalName.split('/').pop();
            if (!existingFiles.has(baseName)) {
                existingFiles.add(baseName);
                return baseName;
            }
            
            const [name, ext] = baseName.split('.');
            let counter = 1;
            let newName;
            do {
                newName = `${name}_${counter}.${ext}`;
                counter++;
            } while (existingFiles.has(newName));
            
            existingFiles.add(newName);
            return newName;
        }

        processButton.addEventListener('click', async () => {
            if (!selectedFile) return;

            const selectedModes = Array.from(document.querySelectorAll('input[name="processingMode"]:checked'))
                .map(checkbox => checkbox.value);

            if (selectedModes.length === 0) {
                modeError.classList.remove('hidden');
                return;
            }

            progressDiv.classList.remove('hidden');
            const fileStats = document.getElementById('fileStats');
            fileStats.classList.remove('hidden');
            const statsTable = document.getElementById('statsTable');
            statsTable.innerHTML = '';
            processButton.disabled = true;
            
            try {
                const originZip = new JSZip();
                const loadedZip = await originZip.loadAsync(selectedFile);
                const outputZip = new JSZip();
                
                const xmlFiles = Object.keys(loadedZip.files)
                    .filter(name => name.toLowerCase().endsWith('.xml') && !loadedZip.files[name].dir);
                
                let processed = 0;
                const existingFiles = new Set();

                for (const fileName of xmlFiles) {
                    const content = await loadedZip.file(fileName).async('text');
                    const originalSize = new Blob([content]).size;
                    
                    const processedContent = processXMLContent(content, selectedModes);
                    const processedSize = new Blob([processedContent]).size;
                    
                    // Calculate reduction percentage
                    const reduction = ((originalSize - processedSize) / originalSize * 100).toFixed(1);
                    
                    // Add statistics row
                    const row = document.createElement('tr');
                    row.className = processed % 2 === 0 ? 'bg-white' : 'bg-gray-50';
                    
                    const fileCell = document.createElement('td');
                    fileCell.className = 'px-6 py-4 whitespace-nowrap text-sm text-gray-900';
                    fileCell.textContent = fileName.split('/').pop();
                    
                    const originalSizeCell = document.createElement('td');
                    originalSizeCell.className = 'px-6 py-4 whitespace-nowrap text-sm text-gray-500';
                    originalSizeCell.textContent = formatBytes(originalSize);
                    
                    const processedSizeCell = document.createElement('td');
                    processedSizeCell.className = 'px-6 py-4 whitespace-nowrap text-sm text-gray-500';
                    processedSizeCell.textContent = formatBytes(processedSize);
                    
                    const reductionCell = document.createElement('td');
                    const reductionClass = parseFloat(reduction) > 10 ? 'text-green-600 font-medium' : 'text-blue-500';
                    reductionCell.className = `px-6 py-4 whitespace-nowrap text-sm ${reductionClass}`;
                    reductionCell.textContent = `${reduction}%`;
                    
                    row.appendChild(fileCell);
                    row.appendChild(originalSizeCell);
                    row.appendChild(processedSizeCell);
                    row.appendChild(reductionCell);
                    
                    statsTable.appendChild(row);

                    // Determine output filename and add to the new zip
                    // When flattenStructure is selected, all XML files go to root level
                    if (selectedModes.includes('flattenStructure')) {
                        const basename = fileName.split('/').pop();
                        const outputName = getUniqueFilename(existingFiles, basename);
                        outputZip.file(outputName, processedContent);
                    } else {
                        // Keep original path
                        outputZip.file(fileName, processedContent);
                    }
                    
                    processed++;
                    const progress = Math.round((processed / xmlFiles.length) * 100);
                    progressBar.style.width = `${progress}%`;
                    progressStatus.textContent = `${progress}%`;
                }

                // Copy non-XML files with their original paths (always preserve their structure)
                const nonXmlFiles = Object.keys(loadedZip.files)
                    .filter(name => !name.toLowerCase().endsWith('.xml') && !loadedZip.files[name].dir);
                
                for (const fileName of nonXmlFiles) {
                    const content = await loadedZip.file(fileName).async('blob');
                    outputZip.file(fileName, content);
                }

                processedZip = await outputZip.generateAsync({type: 'blob'});
                downloadButton.disabled = false;
                progressStatus.textContent = 'Processing complete!';
                progressStatus.classList.add('text-green-600', 'font-medium');

            } catch (error) {
                console.error('Error processing ZIP:', error);
                progressStatus.textContent = 'Error processing file. Please try again.';
                progressStatus.classList.add('text-red-500', 'font-medium');
            }
        });

        downloadButton.addEventListener('click', () => {
            if (processedZip) {
                const url = URL.createObjectURL(processedZip);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'processed_' + selectedFile.name;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }
        });
    </script>
</body>
</html>